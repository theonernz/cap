<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­˜æ¡£ç³»ç»Ÿæµ‹è¯• - Save/Load Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .test-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        h1, h2 {
            text-align: center;
        }
        .save-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #4caf50;
        }
        .save-item.invalid {
            border-left-color: #f44336;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .log {
            background: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
        }
        .log-entry.error { color: #ff6b6b; }
        .log-entry.success { color: #51cf66; }
        .log-entry.info { color: #74c0fc; }
        pre {
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div class="test-panel">
        <h1>ğŸ® å­˜æ¡£ç³»ç»Ÿæµ‹è¯•</h1>
        <p style="text-align: center;">æµ‹è¯•å­˜æ¡£çš„ä¿å­˜å’ŒåŠ è½½åŠŸèƒ½</p>
    </div>

    <div class="test-panel">
        <h2>ğŸ“‹ å­˜æ¡£åˆ—è¡¨</h2>
        <button onclick="loadSaves()">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
        <button onclick="fixUndefinedSave()">ğŸ”§ ä¿®å¤ undefined å­˜æ¡£</button>
        <div id="savesContainer"></div>
    </div>

    <div class="test-panel">
        <h2>ğŸ“ æ“ä½œæ—¥å¿—</h2>
        <button onclick="clearLog()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
        <div class="log" id="logDisplay"></div>
    </div>

    <script>
        const API_BASE = window.location.origin;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('logDisplay');
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + type;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('logDisplay').innerHTML = '';
            log('æ—¥å¿—å·²æ¸…ç©º', 'info');
        }

        async function loadSaves() {
            try {
                log('æ­£åœ¨åŠ è½½å­˜æ¡£åˆ—è¡¨...', 'info');
                const response = await fetch(`${API_BASE}/api/saves/phonis?multiplayer=true`);
                const result = await response.json();
                
                log(`APIå“åº”: ${JSON.stringify(result)}`, 'info');
                
                if (!result.success) {
                    throw new Error(result.error);
                }

                const container = document.getElementById('savesContainer');
                container.innerHTML = '';

                if (result.saves.length === 0) {
                    container.innerHTML = '<p>æš‚æ— å­˜æ¡£</p>';
                    log('æ²¡æœ‰æ‰¾åˆ°å­˜æ¡£', 'info');
                    return;
                }

                result.saves.forEach(save => {
                    const div = document.createElement('div');
                    div.className = save.id ? 'save-item' : 'save-item invalid';
                    
                    const power = save.playerData?.power || 0;
                    const x = Math.floor(save.playerData?.x || 0);
                    const y = Math.floor(save.playerData?.y || 0);
                    
                    div.innerHTML = `
                        <strong>${save.name || 'æœªå‘½å'}</strong> ${save.id ? '' : 'âŒ (æ— æ•ˆID)'}
                        <br>ID: <code>${save.id || 'undefined'}</code>
                        <br>æ—¶é—´: ${save.dateString}
                        <br>èƒ½åŠ›: ${power} | ä½ç½®: (${x}, ${y})
                        <br>æ‰€æœ‰è€…: ${save.owner?.username || 'æœªçŸ¥'}
                        <br>
                        <button onclick="testLoad('${save.id}')">æµ‹è¯•åŠ è½½</button>
                        <button onclick="showSaveData('${save.id}')">æŸ¥çœ‹æ•°æ®</button>
                        ${save.id ? `<button onclick="deleteSave('${save.id}')">åˆ é™¤</button>` : ''}
                    `;
                    container.appendChild(div);
                });

                log(`âœ… åŠ è½½äº† ${result.saves.length} ä¸ªå­˜æ¡£`, 'success');
            } catch (error) {
                log(`âŒ åŠ è½½å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testLoad(saveId) {
            try {
                log(`æ­£åœ¨æµ‹è¯•åŠ è½½å­˜æ¡£: ${saveId}`, 'info');
                const response = await fetch(`${API_BASE}/api/saves/id/${saveId}`);
                const result = await response.json();
                
                log(`åŠ è½½ç»“æœ: ${JSON.stringify(result).substring(0, 200)}...`, 'info');
                
                if (result.success) {
                    log(`âœ… å­˜æ¡£åŠ è½½æˆåŠŸ`, 'success');
                    log(`- åç§°: ${result.save.name}`, 'info');
                    log(`- èƒ½åŠ›: ${result.save.playerData?.power}`, 'info');
                    log(`- ä½ç½®: (${result.save.playerData?.x}, ${result.save.playerData?.y})`, 'info');
                } else {
                    log(`âŒ å­˜æ¡£åŠ è½½å¤±è´¥: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function showSaveData(saveId) {
            try {
                const response = await fetch(`${API_BASE}/api/saves/id/${saveId}`);
                const result = await response.json();
                
                if (result.success) {
                    const popup = document.createElement('div');
                    popup.style.cssText = `
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: rgba(0, 0, 0, 0.95);
                        padding: 30px;
                        border-radius: 15px;
                        max-width: 80%;
                        max-height: 80%;
                        overflow: auto;
                        z-index: 1000;
                    `;
                    popup.innerHTML = `
                        <h3>å­˜æ¡£æ•°æ®</h3>
                        <pre>${JSON.stringify(result.save, null, 2)}</pre>
                        <button onclick="this.parentElement.remove()">å…³é—­</button>
                    `;
                    document.body.appendChild(popup);
                }
            } catch (error) {
                log(`âŒ æŸ¥çœ‹å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function deleteSave(saveId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå­˜æ¡£å—ï¼Ÿ')) return;
            
            try {
                log(`æ­£åœ¨åˆ é™¤å­˜æ¡£: ${saveId}`, 'info');
                const response = await fetch(`${API_BASE}/api/saves/${saveId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                
                if (result.success) {
                    log(`âœ… å­˜æ¡£å·²åˆ é™¤`, 'success');
                    loadSaves();
                } else {
                    log(`âŒ åˆ é™¤å¤±è´¥: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`âŒ åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function fixUndefinedSave() {
            try {
                log('æ­£åœ¨ä¿®å¤ undefined å­˜æ¡£...', 'info');
                
                // è¯»å–æ‰€æœ‰å­˜æ¡£
                const response = await fetch(`${API_BASE}/game/eatscallop/data/savedgames.json`);
                const data = await response.json();
                
                log(`å½“å‰å­˜æ¡£: ${JSON.stringify(Object.keys(data.saves))}`, 'info');
                
                if (data.saves.undefined) {
                    log('âŒ å‘ç° undefined å­˜æ¡£ï¼Œéœ€è¦æ‰‹åŠ¨ä¿®å¤', 'error');
                    log('è¯·æ£€æŸ¥ savedgames.json æ–‡ä»¶', 'error');
                } else {
                    log('âœ… æ²¡æœ‰å‘ç° undefined å­˜æ¡£', 'success');
                }
            } catch (error) {
                log(`âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½å­˜æ¡£åˆ—è¡¨
        log('æµ‹è¯•é¡µé¢å·²åŠ è½½', 'success');
        loadSaves();
    </script>
</body>
</html>
